name: Update Scoop Manifest

on:
  repository_dispatch:
    types: [update-manifest, update-stable-manifest]
  schedule:
    # Fallback check every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine manifest file
        id: manifest
        run: |
          if [ "${{ github.event.action }}" = "update-stable-manifest" ]; then
            echo "file=bloom.json" >> $GITHUB_OUTPUT
          else
            echo "file=bloom-dev.json" >> $GITHUB_OUTPUT
          fi

      - name: Fetch Release Info
        id: fetch
        run: |
          # Check if triggered by repository_dispatch with payload
          if [ -n "${{ github.event.client_payload.hash }}" ]; then
            echo "Using payload from repository_dispatch"
            echo "url=${{ github.event.client_payload.url }}" >> $GITHUB_OUTPUT
            echo "hash=${{ github.event.client_payload.hash }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "Found version: ${{ github.event.client_payload.version }}"
            echo "SHA256: ${{ github.event.client_payload.hash }}"
            exit 0
          fi
          
          # Fallback: fetch from GitHub API
          REPO="crowquillx/Bloom"
          echo "Checking release for repo: $REPO"
          
          RELEASE=$(curl -s "https://api.github.com/repos/$REPO/releases/tags/dev-latest")
          
          # Check if release exists
          if echo "$RELEASE" | jq -e '.message == "Not Found"' > /dev/null 2>&1; then
            echo "Release 'dev-latest' not found in $REPO"
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extract URL and hash from release body
          URL=$(echo "$RELEASE" | jq -r '.assets[] | select(.name == "Bloom-Windows.zip") | .browser_download_url')
          HASH=$(echo "$RELEASE" | jq -r '.body' | grep -oE '[a-fA-F0-9]{64}' | head -1)
          VERSION=$(date -u +%Y.%m.%d.%H%M)
          
          if [ -z "$URL" ] || [ -z "$HASH" ]; then
            echo "Could not extract URL or hash from release"
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "Found version: $VERSION"
          echo "SHA256: ${HASH:0:16}..."

      - name: Update Manifest
        run: |
          URL="${{ steps.fetch.outputs.url }}"
          HASH="${{ steps.fetch.outputs.hash }}"
          VERSION="${{ steps.fetch.outputs.version }}"
          MANIFEST="${{ steps.manifest.outputs.file }}"
          
          if [ -z "$URL" ] || [ -z "$HASH" ]; then
            echo "Failed to fetch release info"
            exit 1
          fi
          
          # Update the determined manifest file
          jq --arg version "$VERSION" \
             --arg url "$URL" \
             --arg hash "$HASH" \
             '.version = $version |
              .architecture["64bit"].url = $url |
              .architecture["64bit"].hash = $hash' \
             "$MANIFEST" > "${MANIFEST}.tmp"
          
          mv "${MANIFEST}.tmp" "$MANIFEST"

      - name: Check for Changes
        id: check
        run: |
          MANIFEST="${{ steps.manifest.outputs.file }}"
          if git diff --quiet "$MANIFEST"; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to manifest"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Manifest updated"
          fi

      - name: Commit and Push
        if: steps.check.outputs.changed == 'true' && steps.fetch.outputs.version != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bloom.json bloom-dev.json
          git commit -m "Update ${{ steps.manifest.outputs.file }} to version ${{ steps.fetch.outputs.version }}"
          git push
